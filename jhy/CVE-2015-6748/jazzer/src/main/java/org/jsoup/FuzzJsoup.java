package org.jsoup;

import java.util.Iterator;

import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.parser.Parser;
import org.jsoup.safety.Cleaner;
import org.jsoup.safety.Whitelist;

import com.code_intelligence.jazzer.api.FuzzedDataProvider;
import com.code_intelligence.jazzer.api.FuzzerSecurityIssueHigh;

/**
 * FuzzJsoup
 */
public class FuzzJsoup {
    // https://github.com/jhy/jsoup/pull/582
    // "the source of the problem was related to how Jsoup handled tags without a closing > when reaching EOF."

    public static void fuzzerTestOneInput(FuzzedDataProvider data) {
        String html = data.consumeRemainingAsAsciiString();

        Document fragment = Jsoup.parse(html, "", Parser.xmlParser());
        Iterator<Element> nodes = fragment.children().iterator();

        // add the fragment's nodes to the body of resulting document
        Document document = Document.createShell("");
        while (nodes.hasNext()) {
            document.body().appendChild(nodes.next());
        }

        if (new Cleaner(Whitelist.basicWithImages()).isValid(document)) {
            assert !html.contains("<img src=a onerror=alert(1)") : new FuzzerSecurityIssueHigh("XSS detected");
        }
    }
}
